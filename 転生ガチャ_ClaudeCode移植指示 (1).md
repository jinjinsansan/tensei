# 転生ガチャ — Claude Code 移植指示書

---

## 全体方針

尊師ガチャ（V4）の **設計思想・ロジック・アーキテクチャ** を継承し、
「転生ガチャ〜来世ルーレット〜」として **新規プロジェクト** に構築する。

コードのコピペではなく、設計を理解した上で **クリーンに新規実装** する。

---

# ========================================
# STEP 1: 尊師ガチャのClaude Codeに渡すプロンプト
# ========================================
# ※尊師ガチャのプロジェクトで実行してください

```
あなたには、この尊師ガチャプロジェクトの設計を完全に読み取り、
新しいプロジェクトに移植するための「設計書」を作成してもらいます。

以下の情報を1つのマークダウンファイル（sonshi_gacha_architecture.md）に
書き出してください。

## 書き出してほしい情報

### 1. プロジェクト全体構造
- ディレクトリ構成（全ファイル一覧）
- 使用技術（フレームワーク、ライブラリ、DB等）
- デプロイ方法

### 2. データベース設計
- 全テーブルのCREATE文（V4で実際に使っているテーブルのみ）
- 各テーブルの役割説明
- テーブル間のリレーション
- ※V1〜V3の古いテーブルは除外してOK

### 3. ガチャエンジン（核心ロジック）
- RTP（還元率）の計算ロジック — コードそのまま抜き出し
- ★1〜★12のレア度決定ロジック
- どんでん返しの発動条件と処理フロー
- 追撃（二段階転生）の発動条件と処理フロー
- シナリオ選択ロジック（テーマ→コマ順再生の仕組み）

### 4. API一覧
- 全APIエンドポイントのリスト
- 各APIのリクエスト/レスポンス形式
- 認証の仕組み

### 5. フロントエンド
- ガチャ実行フロー（ユーザー操作→API呼び出し→動画再生→結果表示）
- 動画プレーヤーの実装方法（コマ送り、テロップ表示）
- テロップ演出の種類と表示ロジック
- カード結果画面の表示方法

### 6. 管理者パネル
- 管理者パネルの機能一覧
- 動画アップロードの仕組み
- シナリオ編集の仕組み
- RTP設定の仕組み

### 7. 動画管理
- 動画ファイルの保存場所・命名規則
- 動画とシナリオの紐付け方法
- 動画の再生順序の管理方法

### 8. 重要な設計判断・注意点
- 開発中にハマったバグや注意点
- パフォーマンス上の工夫
- V1→V4で改善された点

## 出力ルール
- sonshi_gacha_architecture.md として保存
- コードの抜き出しは、関数全体をそのまま貼り付け
- テーブル定義はCREATE文そのまま
- 「なぜそうしたか」の理由も書く
- 新プロジェクトの開発者がこのファイルだけで全体を理解できるように
```

---

# ========================================
# STEP 2: 新プロジェクトを作成
# ========================================

新しいClaude Codeプロジェクトを作成してください。
プロジェクト名: `tensei-gacha` （転生ガチャ）

---

# ========================================
# STEP 3: 新プロジェクトのClaude Codeに渡すプロンプト
# ========================================
# ※STEP 1で生成した sonshi_gacha_architecture.md を
# 新プロジェクトのナレッジに追加してから実行

```
あなたは「転生ガチャ〜来世ルーレット〜」という新しいガチャサイトを構築します。

## 前提
- 添付の sonshi_gacha_architecture.md は、前身プロジェクト「尊師ガチャ」の設計書です
- この設計思想・ロジック・アーキテクチャを継承して新規構築します
- コードのコピペではなく、クリーンに新規実装してください

## プロジェクト概要

### サービス名
転生ガチャ 〜来世ルーレット〜

### コンセプト
ユーザーがガチャを回すと、キャラクターが「転生」する物語が動画で展開される。
転生先は「人生の種類」（サラリーマン、経営者、アーティスト等）で、
★1（最悪の転生）〜★12（伝説の転生）のレア度がある。
途中で「どんでん返し」が発動し、レア度が逆転することもある。

### 尊師ガチャとの違い
- 世界観: 競馬予想 → 転生（来世の人生）
- キャラ: 尊師・グリ・伊東・瀧川 → 健太・（今後追加される6名）
- テーマ: 7つのシナリオテーマ → 7人のキャラクター（各12枚のカード）
- NG要素: 「死ね」「クビ」等の過激表現は一切なし
- 拡張性: キャラクターを後から何人でも追加できる設計にする

## アーキテクチャ要件

### 技術スタック
尊師ガチャと同じ技術スタックを使用してください。
（sonshi_gacha_architecture.md の技術スタック参照）

### DB設計の方針
以下のエンティティを中心に設計してください:

#### characters（キャラクター）テーブル
- id, name, description, expectation_level（期待度★）, thumbnail_url
- is_active（有効/無効 — キャラ追加時にON/OFFできるように）
- sort_order（表示順）
- 例: 健太（25歳、コンビニ店員、期待度★★☆☆☆）

#### cards（カード）テーブル
- id, character_id, card_name, star_level（★1〜12）, rarity（N/R/SR/SSR/UR/LR）
- card_image_url, description
- has_reversal（どんでん返しがあるカードかどうか）
- 例: ★12「世界の伝説 健太」LR

#### scenarios（シナリオ）テーブル
- id, card_id, phase（pre_story / chance / main_story / reversal）
- scene_order（コマ順）
- video_url, duration, telop_text, telop_type
- 例: 健太★12の転生前パターンA、コマ1

#### pre_stories（転生前シナリオ）テーブル
- id, character_id, pattern（A/B/C/D...）, scene_order
- video_url, description
- ※転生前は★に関係なくランダム選択されるので別テーブル

#### chance_scenes（転生チャンスシーン）テーブル
- id, character_id, pattern（A/B/C/D...）
- video_url, description
- ※転生チャンスも★に関係なくランダム選択

#### gacha_config（ガチャ設定）テーブル
- RTP設定（尊師ガチャのRTPロジックを継承）
- どんでん返し発動率
- キャラクター出現率の重み付け

#### gacha_results（ガチャ結果）テーブル
- id, user_session_id, character_id, card_id
- star_level, had_reversal, created_at
- ※統計・分析用

#### card_collection（カード図鑑）テーブル
- id, user_session_id, card_id, obtained_at
- ※ユーザーが集めたカードの記録

### ガチャフロー（最重要）

```
1. ユーザーがガチャボタンを押す
2. サーバー側でRTPに基づいて★1〜12を決定
3. ★に対応するキャラクターをランダム選択（現在は健太のみ）
4. ★に対応するカードを決定
5. レスポンスとして以下を返す:
   - 転生前シナリオ（ランダムパターン）の動画URL群
   - 転生チャンスシーン（ランダムパターン）の動画URL
   - メインシナリオの動画URL群
   - どんでん返しがある場合はその動画URL群
   - 最終カード情報
   - テロップ情報
6. フロントエンドで動画を順番に再生
7. 最後にカード結果を表示
8. カード図鑑に記録
```

### 管理者パネル

以下の機能を持つ管理画面を作成:

1. **キャラクター管理**
   - キャラクターの追加/編集/有効・無効切替
   - キャラクターの期待度設定

2. **カード管理**
   - カードの追加/編集
   - ★レベル、レア度、画像の設定
   - どんでん返しフラグの設定

3. **シナリオ管理**
   - 動画のアップロード
   - コマ順の設定
   - テロップの設定
   - 転生前/チャンス/メイン/どんでん返しの各フェーズ管理

4. **ガチャ設定**
   - RTP（還元率）の調整
   - ★1〜12の出現確率設定
   - どんでん返し発動率の設定
   - キャラクター出現率の重み設定

5. **統計ダッシュボード**
   - ガチャ回数、各★の出現回数
   - 人気カードランキング
   - RTP実績値

## 今回のタスク（基礎構築）

まずは以下を完成させてください:

1. プロジェクトのセットアップ
2. DB作成（全テーブル）
3. ガチャエンジン（RTP + ★決定 + カード決定 + どんでん返し判定）
4. ガチャ実行API
5. 動画プレーヤー（コマ送り再生）
6. カード結果表示画面
7. 管理者パネル（基本CRUD）
8. カード図鑑画面

動画データはまだないので、プレースホルダー（ダミー画像/テスト動画）で構いません。
「健太」のカード12枚をシードデータとして投入してください。

### 健太のカード12枚シードデータ

| card_id | star | rarity | card_name | has_reversal | base_scenario |
|---------|------|--------|-----------|-------------|---------------|
| 1 | 1 | N | コンビニ店員 健太 | false | 転生失敗 |
| 2 | 2 | N | 小アジの健太 | false | 最悪：アジ |
| 3 | 3 | R | 異国の少年 健太 | false | 悪い：貧しい国 |
| 4 | 4 | R | 再起の魂 健太 | true | 転生失敗→逆転 |
| 5 | 5 | SR | 海神の化身 健太 | true | 最悪→逆転 |
| 6 | 6 | SR | 村の英雄 健太 | true | 悪い→逆転 |
| 7 | 7 | SSR | 幸せの父 健太 | false | そこそこ：サラリーマン |
| 8 | 8 | SSR | コンビニ王 健太 | false | ラッキー：経営者 |
| 9 | 9 | UR | 伝説の経営者 健太 | true | そこそこ→逆転 |
| 10 | 10 | UR | 世界のコンビニ王 健太 | true | ラッキー→逆転 |
| 11 | 11 | LR | 東京ドームの星 健太 | false | レア：アーティスト |
| 12 | 12 | LR | 世界の伝説 健太 | true | レア→逆転 |

### RTP設定（初期値）

| ★ | 排出率 |
|---|--------|
| 1 | 15% |
| 2 | 13% |
| 3 | 12% |
| 4 | 11% |
| 5 | 10% |
| 6 | 9% |
| 7 | 8% |
| 8 | 7% |
| 9 | 5% |
| 10 | 4% |
| 11 | 4% |
| 12 | 2% |

※管理者パネルから後で変更可能にすること

### 重要な設計原則

1. **キャラクター追加が容易な設計** — 健太と同じ構造で2人目、3人目を追加するだけで動くように
2. **動画差し替えが容易** — 管理画面から動画をアップロード・差し替えできるように
3. **過激な表現なし** — UI上の全テキストにおいて、死ね・クビ等のネガティブ表現を使わない
4. **企業コラボ対応** — 将来的にブランドロゴやスポンサー表示を追加できる余地を残す
5. **モバイルファースト** — 9:16縦型動画が前提。スマホでの操作を最優先

以上の仕様で基礎構築を開始してください。
まず全体の実装計画を提示してから、順番に実装してください。
```

---

# ========================================
# 補足: ファイル受け渡しの手順
# ========================================

1. 尊師ガチャのClaude Codeで STEP 1 のプロンプトを実行
2. 出力された `sonshi_gacha_architecture.md` をダウンロード
3. 新プロジェクト `tensei-gacha` を作成
4. `sonshi_gacha_architecture.md` をプロジェクトのナレッジに追加
5. STEP 3 のプロンプトを実行
6. Claude Codeが基礎構築を開始

# ========================================
# 注意事項
# ========================================

- STEP 1 と STEP 3 は別々のプロジェクトで実行すること
- 「行ったり来たり」は不要。設計書を受け渡すだけでOK
- STEP 3 実行後、Claude Codeが質問してきたら随時回答する
- 動画はまだないので、ダミーデータで進める
- 基礎構築が完了したら、動画生成（Vidu）に進む
